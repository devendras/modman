<?php
 class Omx_Hooks_Model_Giftcertificate_Sales_Order_Invoice_Total_Giftcertificate extends Mage_Sales_Model_Order_Invoice_Total_Abstract { public function collect(Mage_Sales_Model_Order_Invoice $invoice) { $order = $invoice->getOrder(); $baseGcUsed = $invoice->getOrder()->getBaseOmxGiftCertificatesAmountUsed(); $gcUsed = $invoice->getOrder()->getOmxGiftCertificatesAmountUsed(); $baseGcInvoiced = $invoice->getBaseOmxGiftCertificatesAmountUsed(); $gcInvoiced = $invoice->getOmxGiftCertificatesAmountUsed(); if ($baseGcUsed != $baseGcInvoiced) { $baseDifference = $baseGcInvoiced - $baseGcUsed; $difference = $gcInvoiced - $gcUsed; $invoice->setBaseGrandTotal($invoice->getBaseGrandTotal()+$baseDifference); $invoice->setGrandTotal($invoice->getGrandTotal()+$difference); } $invoice->setBaseGiftCardsAmount($baseGcUsed); $invoice->setGiftCardsAmount($gcUsed); return $this; } }