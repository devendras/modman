<?php
 class Omx_Hooks_Model_Giftcertificate_Sales_Quote_Address_Total_Giftcertificate extends Mage_Sales_Model_Quote_Address_Total_Abstract { public function __construct() { $this->setCode('omxgiftcertificate'); } public function collect(Mage_Sales_Model_Quote_Address $address) { parent::collect($address); $addressBaseGrandTotal = $address->getBaseGrandTotal(); $quote = $address->getQuote(); $this->_collectQuoteCerificates($quote); if ($addressBaseGrandTotal>0) { $baseGcAmount = $quote->getBaseOmxGiftCertificatesAmount(); $baseGcUsed = (float)$quote->getBaseOmxGiftCertificatesAmountUsed(); $baseGcAmountLeft = $baseGcAmount - $baseGcUsed; $baseGcAmountLeft = ($baseGcAmountLeft < 0) ? 0 : $baseGcAmountLeft; $baseGcForThisAddress = ($addressBaseGrandTotal > $baseGcAmountLeft) ? $baseGcAmountLeft : $addressBaseGrandTotal; $GcForThisAddress = $quote->getStore()->convertPrice($baseGcForThisAddress, false); if($baseGcForThisAddress > 0) { $address->setBaseGrandTotal($address->getBaseGrandTotal()-$baseGcForThisAddress); $address->setGrandTotal($address->getGrandTotal()-$GcForThisAddress); $address->setBaseOmxGiftCertificatesAmountUsed($baseGcForThisAddress); $quote->setBaseOmxGiftCertificatesAmountUsed($quote->getBaseOmxGiftCertificatesAmountUsed+$baseGcForThisAddress); $address->setHasOmxGiftCertificates(true); } else { $address->setHasOmxGiftCertificates(false); } $address->save(); } return $this; } public function fetch(Mage_Sales_Model_Quote_Address $address) { $amount = $address ->getBaseOmxGiftCertificatesAmountUsed(); if($amount>0 && $address->getHasOmxGiftCertificates()) { $cert = Mage::helper('hooks/giftcertificate')->getCertificates($address->getQuote()); $address->addTotal(array( 'code'=>$this->getCode(), 'title'=>Mage::helper('enterprise_giftcardaccount')->__('Gift Certificate'), 'value'=>$amount, 'certcode' => $cert[0]['code'], 'certid' => $cert[0]['id'], )); } return $this; } protected function _collectQuoteCerificates(Mage_Sales_Model_Quote $quote) { if(!$quote->getOmxGiftCertificateTotalCollected()) { $quote->setBaseOmxGiftCertificatesAmount(0); $quote->setBaseOmxGiftCertificatesAmountUsed(0); $quoteAddresses = $quote->getAllAddresses(); foreach($quoteAddresses as $quoteAddress) { $quoteAddress->setBaseOmxGiftCertificatesAmountUsed(0); } $baseAmount = 0; $certificates = Mage::helper('hooks/giftcertificate')->getCertificates($quote); if(count($certificates)) { foreach($certificates as $cert) { $baseAmount += $cert['base_balance']; } } $quote->setBaseOmxGiftCertificatesAmount($baseAmount); $quote->setOmxGiftCertificateTotalCollected(true); } } }