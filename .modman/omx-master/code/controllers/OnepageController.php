<?php
require_once 'Mage/Checkout/controllers/OnepageController.php'; class Omx_Hooks_OnepageController extends Mage_Checkout_OnepageController { public function _construct() { parent::_construct(); } public function preDispatch() { parent::preDispatch(); } public function saveBillingAction() { parent::saveBillingAction(); $result = Mage::helper('core/data')->jsonDecode($this->getResponse()->getBody()); if (!isset($result['error'])) { if(Mage::helper('hooks/data')->getSettings('useOmxMarketingPolicies') == '1') { $quote = Mage::getSingleton('checkout/session')->getQuote(); $freeItemDiscounts = Mage::helper('hooks/omxpricing')->getDiscounts( $quote, Omx_Hooks_Model_Omxpricing_Calculator::OMX_FREE_ITEM_DISCOUNTS ); $canSelectItem = false; if(array_key_exists('canSelect', $freeItemDiscounts)) { $canSelectItem = $freeItemDiscounts['canSelect']; } if ($quote->isVirtual() && $canSelectItem) { unset($result['update_section']); $result['goto_section'] = 'omxdiscount'; $this->getResponse()->setBody(Mage::helper('core')->jsonEncode($result)); } } } } public function saveShippingMethodAction() { parent::saveShippingMethodAction(); $currentConnectionState = Mage::getModel('hooks/connector')->getCurrentConnectionState(); if( Mage::helper('hooks/data')->getSettings('useOmxMarketingPolicies') == '1' && $currentConnectionState ) { $quote = Mage::getSingleton('checkout/session')->getQuote(); $freeItemDiscounts = Mage::helper('hooks/omxpricing')->getDiscounts( $quote, Omx_Hooks_Model_Omxpricing_Calculator::OMX_FREE_ITEM_DISCOUNTS ); $canSelectItem = (array_key_exists('canSelect', $freeItemDiscounts)) ? $freeItemDiscounts['canSelect'] : false; if ($canSelectItem) { $result = Mage::helper('core')->jsonDecode($this->getResponse()->getBody()); unset($result['update_section']); $result['goto_section'] = 'omxdiscount'; $this->getResponse()->setBody(Mage::helper('core')->jsonEncode($result)); } } } public function saveOmxdiscountAction() { $this->_expireAjax(); if ($this->getRequest()->isPost()) { $data = $this->getRequest()->getPost('omxdiscount', ''); $opTypeClass= $this->getOnepage(); if ($opTypeClass instanceof Omx_Hooks_Model_Omxpricing_Checkout_Type_Onepage) { $result= $opTypeClass->saveOmxdiscount($data); } Mage::dispatchEvent( 'checkout_controller_onepage_save_omxdiscount', array('request'=>$this->getRequest(), 'quote'=>$this->getOnepage()->getQuote() ) ); $this->getResponse()->setBody(Mage::helper('core')->jsonEncode($result)); $result['omxdiscount_html'] = $this->_getOmxdiscountHtml(); $result['goto_section'] = 'payment'; $result['update_section'] = array( 'name' => 'payment-method', 'html' => $this->_getPaymentMethodsHtml() ); $this->getResponse()->setBody(Mage::helper('core')->jsonEncode($result)); } } protected function _getOmxdiscountHtml() { $layout = Mage::getModel('Core/Layout'); $update = $layout->getUpdate(); $update->load('checkout_onepage_omxdiscount'); $layout->generateXml(); $layout->generateBlocks(); $output = $layout ->getBlock('hooks_omxdiscount') ->setUpdate(true) ->toHtml(); return $output; } }