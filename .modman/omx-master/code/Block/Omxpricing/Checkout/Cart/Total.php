<?php
 class Omx_Hooks_Block_Omxpricing_Checkout_Cart_Total extends Mage_Checkout_Block_Total_Default { protected $_template = 'hooks/omxpricing/checkout/cart/total.phtml'; const REDIRECT_PAYPAL_EXPRESS_REVIEW = 'paypal_express'; const REDIRECT_CART = 'cart'; protected function _construct() { parent::_construct(); } protected function _getQuote() { return Mage::getSingleton('checkout/session')->getQuote(); } public function getDiscountLines() { $amountDiscountsData = array(); $amountDiscountsData = $this->getTotal()->getData(); if(!array_key_exists('discount_lines', $amountDiscountsData)) { return array(); } if(!array_key_exists('discountPolicies', $amountDiscountsData['discount_lines'])) { return array(); } return $amountDiscountsData['discount_lines']['discountPolicies']; } public function getFreeItemDiscounts() { $freeItemDiscountsData = $this->getTotal()->getData(); return $freeItemDiscountsData['free_items_discounts']['selections']; } public function freeItemCanSelect() { $freeItemDiscountsData = $this->getTotal()->getData(); return $freeItemDiscountsData['free_items_discounts']['canSelect']; } public function freeItemGetSelected($details = true) { $freeItemDiscountsData = $this->getTotal()->getData(); if (!$details) { return $freeItemDiscountsData['free_items_discounts']['selectedItems']; } $itemDetails = array(); if(array_key_exists('selectedItems', $freeItemDiscountsData['free_items_discounts'])) { foreach($freeItemDiscountsData['free_items_discounts']['selectedItems'] as $policyId=>$itemCode) { $itemDetails[$policyId]= array( 'sku' => $itemCode, 'name' => '', 'qty' => '', ); if(array_key_exists( $policyId, $freeItemDiscountsData['free_items_discounts']['selections'] ) ){ foreach($freeItemDiscountsData['free_items_discounts']['selections'][$policyId]['items'] as $item) { if($item['itemCode'] != $itemCode) { continue; }; $itemDetails[$policyId]['name'] = $item['name']; $itemDetails[$policyId]['qty'] = $item['qty']; } } } } return $itemDetails; } public function getRedirectLocation() { $request = $this->getRequest(); if (mb_strtolower($request->getControllerModule() ) == 'mage_paypal' && mb_strtolower($request->getControllerName() ) == 'express' && mb_strtolower($request->getActionName() ) == 'review' ) { return self::REDIRECT_PAYPAL_EXPRESS_REVIEW; } return self::REDIRECT_CART; } public function getCurrentConnectionState() { return Mage::getModel('hooks/connector')->getCurrentConnectionState(); } }