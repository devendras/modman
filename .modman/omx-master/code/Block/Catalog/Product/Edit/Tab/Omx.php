<?php
 class Omx_Hooks_Block_Catalog_Product_Edit_Tab_Omx extends Mage_Adminhtml_Block_Widget_Form { protected $_last_checked; protected $_product_exists; protected $_details_match; protected $_last_pushed; protected $_last_updated; protected $_last_inventory_check; protected $_last_received_from_omx; public function __construct() { parent::__construct(); $this->setId('omx_product_form'); $this->setUseAjax(true); } protected function _prepareLayout() { $product = Mage::registry('product'); $products = Mage::getModel('catalog/product')->getCollection() ->addAttributeToSelect("omx_last_checked") ->addAttributeToSelect("omx_product_exists") ->addAttributeToSelect("omx_details_match") ->addAttributeToSelect("omx_last_pushed") ->addAttributeToSelect("omx_last_updated") ->addAttributeToSelect("omx_iir_timestamp") ->addAttributeToSelect("omx_last_received_from_omx"); $wantedProduct = $products->getItemById($product->getId()); $this->_last_checked = $wantedProduct->getOmxLastChecked(); $this->_product_exists = $wantedProduct->getOmxProductExists(); $this->_details_match = $wantedProduct->getOmxDetailsMatch(); $this->_last_pushed = $wantedProduct->getOmxLastPushed(); $this->_last_updated = $wantedProduct->getOmxLastUpdated(); $this->_last_inventory_check = $wantedProduct->getOmxIirTimestamp(); $this->_last_received_from_omx = $wantedProduct->getOmxLastReceivedFromOmx(); $checknow_url = $this->getUrl('hooks/product/checknow', array('_current' => true)); $pushnow_url = $this->getUrl('hooks/product/pushnow', array('_current' => true)); $create_url = $this->getUrl('hooks/product/create', array('_current' => true)); $omxTabId = 'product_info_tabs_omx_content'; $this->setChild('check_button', $this->getLayout()->createBlock('adminhtml/widget_button') ->setData(array( 'label' => Mage::helper('hooks')->__('Check Now'), 'id' => 'check_button', 'onclick' => 'new Ajax.Updater({ success: \''.$omxTabId.'\' }, \''.$checknow_url.'\', { method: \'post\' })' )) ); $this->setChild('create_button', $this->getLayout()->createBlock('adminhtml/widget_button') ->setData(array( 'label' => Mage::helper('hooks')->__('Create In OMX Now'), 'id' => 'create_button', 'onclick' => 'var agree = confirm(\'' . Mage::helper('hooks')->__('The OMX item will be created in -Incomplete- status, and should be updated in OMX before it is made available for purchase.\nWould you like to create this item in OMX now?') . '\');
                                    if(agree) new Ajax.Updater({ success: \''.$omxTabId.'\' }, \''.$create_url.'\', { method: \'post\' });' )) ); $this->setChild('push_button', $this->getLayout()->createBlock('adminhtml/widget_button') ->setData(array( 'label' => Mage::helper('hooks')->__('Push to OMX Now'), 'id' => 'push_button', 'onclick' => 'var agree = confirm(\'' . Mage::helper('hooks')->__('This will overwrite all Magento-tracked properties in the OMX system for this item.\nWould you like to update the OMX item now?') . '\');
                                    if(agree) new Ajax.Updater({ success: \''.$omxTabId.'\' }, \''.$pushnow_url.'\', { method: \'post\' });' )) ); return parent::_prepareLayout(); } protected function _prepareForm() { $form = new Varien_Data_Form(); $fieldset = $form->addFieldset('omx', array('legend'=>Mage::helper('hooks')->__('OMX'))); $entityType = Mage::registry('product')->getResource()->getEntityType(); $fieldset->addField('last_checked', 'label', array( 'name' =>'last_checked', 'label' => Mage::helper('hooks')->__('Last Checked in OMX'), 'title' => Mage::helper('hooks')->__('Last Checked in OMX') )); $fieldset->addField('check_button_field', 'note', array( 'text' => $this->getChildHtml('check_button'), )); $fieldset->addField('product_exists', 'checkbox', array( 'name' => 'product_exists', 'title' => Mage::helper('hooks')->__('Product Exists in OMX'), 'label' => Mage::helper('hooks')->__('Product Exists in OMX'), 'checked' => false, 'disabled' => 'disabled' ) ); if (!$this->_product_exists){ $fieldset->addField('create_button_field', 'note', array( 'text' => $this->getChildHtml('create_button'), )); } else { $fieldset->addField('details_match', 'checkbox', array( 'name' => 'product_match', 'title' => Mage::helper('hooks')->__('Product Details Match in OMX'), 'label' => Mage::helper('hooks')->__('Product Details Match in OMX'), 'checked' => false, 'disabled' => 'disabled' ) ); $fieldset->addField('push_button_field', 'note', array( 'text' => $this->getChildHtml('push_button'), )); } $fieldset->addField('last_pushed', 'label', array( 'name' =>'last_pushed', 'label' => Mage::helper('hooks')->__('Last Pushed to OMX'), 'title' => Mage::helper('hooks')->__('Last Pushed to OMX') )); $fieldset->addField('last_updated', 'label', array( 'name' =>'last_updated', 'label' => Mage::helper('hooks')->__('Last Updated in OMX'), 'title' => Mage::helper('hooks')->__('Last Updated in OMX') )); $fieldset->addField('last_inventory_check', 'label', array( 'name' =>'last_inventory_check', 'label' => Mage::helper('hooks')->__('Last OMX Inventory Check'), 'title' => Mage::helper('hooks')->__('Last OMX Inventory Check') )); $fieldset->addField('last_received_from_omx', 'label', array( 'name' =>'last_received_from_omx', 'label' => Mage::helper('hooks')->__('Date Last Received from OMX'), 'title' => Mage::helper('hooks')->__('Date Last Received from OMX') )); $this->setForm($form); } protected function _initFormValues() { $form = $this->getForm(); $form->getElement('last_checked')->setValue($this->_last_checked); $form->getElement('product_exists')->setIsChecked($this->_product_exists); if($this->_product_exists){ $form->getElement('details_match')->setIsChecked($this->_details_match); } $form->getElement('last_pushed')->setValue($this->_last_pushed); $form->getElement('last_updated')->setValue($this->_last_updated); $form->getElement('last_inventory_check')->setValue($this->_last_inventory_check); $form->getElement('last_received_from_omx')->setValue($this->_last_received_from_omx); } } 